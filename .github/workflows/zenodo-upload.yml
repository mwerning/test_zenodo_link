name: Upload Excel to Zenodo

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  upload-to-zenodo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq git

      - name: Upload Excel to Zenodo
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
        run: |
          FILE_PATH="Test_data_for_Zenodo.xlsx"
          ZENODO_API="https://zenodo.org/api/deposit/depositions"
          ID_FILE=".zenodo_concept_id"

          TITLE="Excel Dataset – ${{ github.event.release.tag_name }}"
          DESCRIPTION="Automatically uploaded from GitHub release ${{ github.event.release.tag_name }} of repository ${{ github.repository }}."
          
          CREATORS='[
            {"name":"Michaela Werning","affiliation":"International Institute for Applied Systems Analysis"},
            {"name":"Second Author", "affiliation":"Institution Name"}
          ]'

          RELATED_IDENTIFIERS='[
            {"relation":"isSupplementTo","scheme":"url","identifier":"https://github.com/${{ github.repository }}"},
            {"relation":"isDocumentedBy","scheme":"url","identifier":"https://github.com/${{ github.repository }}/releases/tag/${{ github.event.release.tag_name }}"}
          ]'

          LICENSE="cc-by-4.0"
          LANGUAGE="eng"
          PUBLICATION_DATE=$(date +%Y-%m-%d)  # Use today's date for new versions

          # ==========================================================
          # STEP 1 — Create new deposition or new version
          # ==========================================================
          if [ ! -f "$ID_FILE" ]; then
            echo "No concept ID found — creating first Zenodo deposition."

            CREATE=$(curl -s -X POST "$ZENODO_API" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              -d "{
                \"metadata\": {
                  \"title\": \"$TITLE\",
                  \"upload_type\": \"dataset\",
                  \"description\": \"$DESCRIPTION\",
                  \"creators\": $CREATORS,
                  \"license\": \"$LICENSE\",
                  \"related_identifiers\": $RELATED_IDENTIFIERS,
                  \"language\": \"$LANGUAGE\",
                  \"access_right\": \"open\",
                  \"publication_date\": \"$PUBLICATION_DATE\"
                }
              }")

            echo "Create response: $CREATE"

            CONCEPT_ID=$(echo "$CREATE" | jq -r '.conceptrecid')
            DEPOSITION_ID=$(echo "$CREATE" | jq -r '.id')
            BUCKET_URL=$(echo "$CREATE" | jq -r '.links.bucket')

            # Save concept ID permanently
            echo "$CONCEPT_ID" > "$ID_FILE"
            git config user.email "github-actions@github.com"
            git config user.name "github-actions"
            git add "$ID_FILE"
            git commit -m "Store Zenodo concept ID"
            git push

          else
            CONCEPT_ID=$(cat "$ID_FILE")
            echo "Using existing concept ID: $CONCEPT_ID"

            # Get latest deposition ID for this concept (required for GitHub Actions)
            LATEST=$(curl -s "$ZENODO_API?conceptrecid=$CONCEPT_ID" \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              | jq -r '.[0].id')
            echo "Using latest deposition ID: $LATEST"

            # Step 1a: Request new version
            echo "Requesting new version..."
            NEW=$(curl -s -X POST "$ZENODO_API/$LATEST/actions/newversion" \
              -H "Authorization: Bearer $ZENODO_TOKEN")
            echo "Newversion response: $NEW"

            DEPOSITION_ID=$(echo "$NEW" | jq -r '.id')
            echo "New draft deposition ID: $DEPOSITION_ID"

            # Step 1b: Update draft metadata with today's date
            UPDATE=$(curl -s -X PUT "$ZENODO_API/$DEPOSITION_ID" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              -d "{
                \"metadata\": {
                  \"title\": \"$TITLE\",
                  \"upload_type\": \"dataset\",
                  \"description\": \"$DESCRIPTION\",
                  \"creators\": $CREATORS,
                  \"license\": \"$LICENSE\",
                  \"related_identifiers\": $RELATED_IDENTIFIERS,
                  \"language\": \"$LANGUAGE\",
                  \"access_right\": \"open\",
                  \"publication_date\": \"$PUBLICATION_DATE\"
                }
              }")

            # Fetch bucket URL
            DRAFT=$(curl -s "$ZENODO_API/$DEPOSITION_ID" \
              -H "Authorization: Bearer $ZENODO_TOKEN")
            BUCKET_URL=$(echo "$DRAFT" | jq -r '.links.bucket')
          fi

          echo "Deposition ID: $DEPOSITION_ID"
          echo "Bucket URL: $BUCKET_URL"

          # ==========================================================
          # STEP 2 — Upload file
          # ==========================================================
          echo "Uploading file: $FILE_PATH"
          curl --fail -X PUT "${BUCKET_URL}/$(basename "$FILE_PATH")" \
            -H "Authorization: Bearer $ZENODO_TOKEN" \
            --upload-file "$FILE_PATH"

          # Wait for Zenodo to register file
          echo "Waiting for Zenodo to register uploaded file..."
          for i in {1..20}; do
            COUNT=$(curl -s "$ZENODO_API/$DEPOSITION_ID" \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              | jq '.files | length')
            echo "Files registered: $COUNT"
            if [[ "$COUNT" -gt 0 ]]; then
              echo "File successfully registered."
              break
            fi
            sleep 3
          done
          if [[ "$COUNT" -eq 0 ]]; then
            echo "❌ ERROR: Zenodo never registered the uploaded file."
            exit 1
          fi

          # ==========================================================
          # STEP 3 — Publish deposition
          # ==========================================================
          echo "Publishing deposition..."
          PUBLISH_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$ZENODO_API/$DEPOSITION_ID/actions/publish" \
            -H "Authorization: Bearer $ZENODO_TOKEN")

          # Split JSON and HTTP code
          HTTP_BODY=$(echo "$PUBLISH_RESPONSE" | head -n -1)
          HTTP_STATUS=$(echo "$PUBLISH_RESPONSE" | tail -n 1)

          echo "---------- Zenodo Publish Debug ----------"
          echo "HTTP status: $HTTP_STATUS"
          echo "Raw response:"
          echo "$HTTP_BODY"
          echo "------------------------------------------"

          # Validate JSON
          if ! echo "$HTTP_BODY" | jq empty 2>/dev/null; then
            echo "❌ ERROR: Publish returned non-JSON (likely HTML error)"
            exit 1
          fi

          # Check if error block exists
          ERRORS=$(echo "$HTTP_BODY" | jq -r '.errors // empty')
          if [[ ! -z "$ERRORS" && "$ERRORS" != "null" ]]; then
            echo "❌ Zenodo publish errors detected:"
            echo "$ERRORS" | jq .
            exit 1
          fi

          if [[ "$HTTP_STATUS" -ge 300 ]]; then
            echo "❌ Publish failed with HTTP $HTTP_STATUS"
            exit 1
          fi

          DOI=$(echo "$HTTP_BODY" | jq -r '.doi')
          echo "✅ Published successfully!"
          echo "DOI: $DOI"
